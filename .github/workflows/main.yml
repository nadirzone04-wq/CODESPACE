name: macOS con noVNC y Tailscale

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar Dependencias (Tailscale, TigerVNC, noVNC)
        run: |
          # Instalamos todo lo necesario
          brew install tailscale tigervnc novnc
          
          # Iniciar Tailscale
          sudo tailscaled > /dev/null 2>&1 &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-mac-web

      - name: Configurar Servidor VNC
        run: |
          mkdir -p ~/.vnc
          echo "password123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Lanzar TigerVNC en el puerto 5901
          vncserver :1 -geometry 1280x720 -depth 24
          sleep 3

      - name: Lanzar noVNC (Puerto 8080)
        run: |
          # novnc_proxy conecta el puerto 8080 del navegador al 5901 del VNC
          # Lo lanzamos en background (&)
          /opt/homebrew/bin/novnc_proxy --vnc localhost:5901 --listen 8080 &
          sleep 5

      - name: ACCESO POR NAVEGADOR
        run: |
          IP=$(tailscale ip -4)
          echo "========================================================="
          echo "1. ASEGÚRATE DE QUE TU TAILSCALE ESTÁ CONECTADO"
          echo "2. ABRE ESTA URL EN TU NAVEGADOR:"
          echo ""
          echo "http://$IP:8080/vnc.html"
          echo ""
          echo "3. HAZ CLIC EN 'CONNECT' Y PON LA CONTRASEÑA"
          echo "CONTRASEÑA: password123"
          echo "========================================================="

      - name: Mantener vivo (1 hora)
        run: sleep 3600
