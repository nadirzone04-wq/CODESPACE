name: CRD-MacOS-Fixed-UserAgent

on:
  workflow_dispatch:

jobs:
  crd-macos:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Install & Setup Tailscale
        run: |
          echo "üîí Installing Tailscale..."
          brew install tailscale
          sudo tailscaled install-system-daemon
          
          echo "üîë Authenticating Tailscale..."
          TS_HOSTNAME="gh-mac-$GITHUB_RUN_ID"
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$TS_HOSTNAME" --accept-routes
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Install Chrome Remote Desktop (Manual Spoofing)
        run: |
          echo "‚¨áÔ∏è Downloading CRD with User-Agent Spoofing..."
          
          CRD_DMG="$HOME/chromeremotedesktophost.dmg"
          
          # TRUCO: Usamos -A para simular ser un navegador Chrome real y evitar el error 404/403
          curl -L -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
               -o "$CRD_DMG" \
               "https://dl.google.com/chrome-remote-desktop/chromeremotedesktophost.dmg"

          echo "üíø Mounting DMG..."
          hdiutil attach "$CRD_DMG" -nobrowse
          
          echo "üì¶ Installing PKG..."
          # La ruta dentro del DMG suele ser est√°ndar
          sudo installer -pkg /Volumes/Chrome\ Remote\ Desktop\ Host/Chrome\ Remote\ Desktop\ Host.pkg -target /
          
          echo "üßπ Cleaning up..."
          hdiutil detach /Volumes/Chrome\ Remote\ Desktop\ Host
          rm "$CRD_DMG"

      - name: Register Chrome Remote Desktop Host
        run: |
          echo "üöÄ Registering Chrome Remote Desktop host..."
          
          # ‚ö†Ô∏è IMPORTANTE: El c√≥digo expira en 5 minutos.
          # Genera uno nuevo aqu√≠ antes de ejecutar: https://remotedesktop.google.com/headless
          AUTH_CODE="4/0ASc3gC13cmzYwMBeCPJvr6SYXRu_21S36VSTr332O1W86SoZXRpnE6TihBHmb7v6Mf_RVQ"
          PIN="123456"
          HOSTNAME=$(hostname)
          
          # Ruta del binario instalado
          APP_BIN="/Applications/Chrome Remote Desktop Host.app/Contents/MacOS/remoting_start_host"
          
          "$APP_BIN" \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="$HOSTNAME" \
            --pin="$PIN"

      - name: Keep CRD Online
        run: |
          echo "=== üçé macOS System Ready ==="
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "PIN: 123456"
          echo "============================="
          while true; do
            sleep 300
          done
