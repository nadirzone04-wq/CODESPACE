name: macOS con noVNC y Tailscale

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar Dependencias
        run: |
          # Corregido: tiger-vnc con guion
          brew install tailscale tiger-vnc novnc
          
          # Iniciar Tailscale
          sudo tailscaled > /dev/null 2>&1 &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-mac-web

      - name: Configurar Servidor VNC
        run: |
          mkdir -p ~/.vnc
          # Configurar contraseña 'password123'
          echo "password123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Crear un archivo xstartup básico para que cargue la interfaz
          echo "#!/bin/sh" > ~/.vnc/xstartup
          echo "exec /usr/bin/login -f runner" >> ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

          # Lanzar el servidor en el puerto 5901
          # Nota: Usamos el binario con el nombre correcto de brew
          /opt/homebrew/bin/vncserver :1 -geometry 1280x720 -depth 24
          sleep 3

      - name: Lanzar noVNC (Puerto 8080)
        run: |
          # Localizamos el ejecutable de novnc (el nombre varía según la versión de brew)
          NOVNC_PATH=$(find /opt/homebrew/bin -name "novnc_proxy" | head -n 1)
          $NOVNC_PATH --vnc localhost:5901 --listen 8080 &
          sleep 5

      - name: ACCESO POR NAVEGADOR
        run: |
          IP=$(tailscale ip -4)
          echo "========================================================="
          echo "URL DE ACCESO (Necesitas Tailscale activo en tu PC):"
          echo "http://$IP:8080/vnc.html"
          echo "========================================================="
          echo "Password: password123"
          echo "========================================================="

      - name: Mantener vivo
        run: sleep 3600
