name: Debug macOS VNC

on: 
  workflow_dispatch: # Esto permite lanzarlo manualmente con un botón

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Instalar y Configurar Ngrok
        run: |
          brew install ngrok/ngrok/ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Activar VNC (Screen Sharing)
        run: |
          # Establecer contraseña (Cámbiala aquí si quieres, ahora es 'password123')
          VNC_PASSWORD="password123"
          
          # Habilitar el servicio de gestión remota de Apple (Kickstart)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          echo "VNC Activado."

      - name: Iniciar Túnel Ngrok
        run: |
          # Inicia ngrok en el puerto 5900 (Puerto por defecto de VNC) en segundo plano
          ngrok tcp 5900 &
          
          echo "Esperando a que se inicie el túnel..."
          sleep 10
          
          # Obtener la URL pública
          echo "========================================================="
          echo "   COPIA ESTA DIRECCIÓN EN TU VISOR VNC (RealVNC, etc):"
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
          echo "========================================================="
          echo "   La contraseña es: password123"
          echo "========================================================="

      - name: Mantener vivo (Loop)
        run: |
          # Mantiene el runner activo hasta 1 hora o hasta que lo canceles
          # (GitHub mata el proceso a las 6h máx, pero mejor no abusar)
          sleep 3600
