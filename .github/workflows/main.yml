name: Debug macOS VNC (Tailscale)

on: 
  workflow_dispatch: # Botón manual

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Conectar el Runner a tu red Tailscale
      - name: Conectar a Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          # Si usas Auth Key directa (más fácil), comenta las dos líneas de arriba 
          # y descomenta la de abajo:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest
          hostname: github-runner-macbox

      # 2. Configurar VNC (Gestión Remota de Apple)
      - name: Configurar VNC (Screen Sharing)
        run: |
          # Contraseña para entrar al VNC
          VNC_PASSWORD="password123"
          
          # Habilitar el servicio nativo de macOS
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          echo "VNC Activado correctamente."

      # 3. Mostrar la IP para conectarte
      - name: OBTENER IP DE CONEXIÓN
        run: |
          echo "========================================================="
          echo "ESTA MÁQUINA YA ESTÁ EN TU RED TAILSCALE."
          echo "LA IP A LA QUE DEBES CONECTARTE ES:"
          echo ""
          tailscale ip -4
          echo ""
          echo "========================================================="
          echo "Usa tu cliente VNC contra esa IP. Pass: password123"
          echo "========================================================="

      # 4. Mantener vivo (1 hora)
      - name: Mantener vivo
        run: sleep 3600
