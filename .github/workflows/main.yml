name: CRD-MacOS-Stable

on:
  workflow_dispatch:

jobs:
  crd-macos:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Set Wallpaper (Optional)
        run: |
          echo "üñºÔ∏è Downloading wallpaper..."
          # Usamos un User-Agent falso para que Google Drive no bloquee la descarga
          curl -L -A "Mozilla/5.0" -o "$HOME/wallpaper.jpg" "https://drive.google.com/uc?export=download&id=1SmRFyijibBDEbnhYSilSGoxtD_-N2KXu"
          
          # Intentamos poner el fondo, si falla (porque no hay pantalla f√≠sica), ignoramos el error con "|| true"
          osascript -e "tell application \"System Events\" to set picture of every desktop to \"$HOME/wallpaper.jpg\"" || true

      - name: Install Chrome Remote Desktop
        run: |
          echo "üç∫ Installing Chrome Remote Desktop via Homebrew..."
          # Esta es la forma correcta en Mac: dejamos que brew gestione la descarga e instalaci√≥n
          brew install --cask chrome-remote-desktop-host

      - name: Install & Setup Tailscale
        run: |
          echo "üîí Installing Tailscale..."
          brew install tailscale
          
          # Iniciar el servicio de sistema (requiere sudo en Mac)
          sudo tailscaled install-system-daemon
          
          echo "üîë Authenticating Tailscale..."
          # Generamos un nombre √∫nico para no tener conflictos
          TS_HOSTNAME="gh-mac-$GITHUB_RUN_ID"
          
          # Conectamos
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$TS_HOSTNAME" --accept-routes
          
          # Guardamos la IP en variable de entorno
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Register Chrome Remote Desktop Host
        run: |
          echo "üöÄ Registering CRD..."
          
          # ‚ö†Ô∏è OJO: El c√≥digo de autorizaci√≥n (AUTH_CODE) caduca muy r√°pido.
          # Debes generar uno nuevo en https://remotedesktop.google.com/headless justo antes de ejecutar.
          AUTH_CODE="4/0ASc3gC13cmzYwMBeCPJvr6SYXRu_21S36VSTr332O1W86SoZXRpnE6TihBHmb7v6Mf_RVQ"
          PIN="123456"
          HOSTNAME=$(hostname)
          
          # Ruta exacta donde Homebrew instala la app en macOS
          APP_PATH="/Applications/Chrome Remote Desktop Host.app/Contents/MacOS/remoting_start_host"
          
          "$APP_PATH" \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="$HOSTNAME" \
            --pin="$PIN"

      - name: Keep Online
        run: |
          echo ""
          echo "=== üçé macOS System Ready ==="
          echo "IP Tailscale: $TAILSCALE_IP"
          echo "PIN: 123456"
          echo "============================="
          
          # Bucle infinito para que no se cierre el runner
          while true; do
            sleep 300
          done
