name: CRD-MacOS

on:
  workflow_dispatch:

jobs:
  crd-macos:
    runs-on: macos-latest # Usamos la √∫ltima versi√≥n estable de macOS
    timeout-minutes: 3600

    steps:
      - name: Set Wallpaper
        run: |
          echo "üñºÔ∏è Setting custom macOS wallpaper..."
          # URL de tu imagen
          WALLPAPER_URL="https://drive.google.com/uc?export=download&id=1SmRFyijibBDEbnhYSilSGoxtD_-N2KXu"
          WALLPAPER_PATH="$HOME/wallpaper.jpg"

          # Descargar imagen usando curl
          curl -L -o "$WALLPAPER_PATH" "$WALLPAPER_URL"

          # Cambiar fondo usando AppleScript (osascript)
          # Nota: En entornos CI headless a veces esto no es visible hasta que inicia la sesi√≥n gr√°fica
          osascript -e "tell application \"System Events\" to set picture of every desktop to \"$WALLPAPER_PATH\""

      - name: Set up Chrome Remote Desktop
        run: |
          echo "‚¨áÔ∏è Installing Chrome Remote Desktop..."
          CRD_DMG="$HOME/chromeremotedesktophost.dmg"
          
          # Descargar el DMG
          curl -L -o "$CRD_DMG" "https://dl.google.com/chrome-remote-desktop/chromeremotedesktophost.dmg"
          
          # Montar el DMG
          hdiutil attach "$CRD_DMG" -nobrowse
          
          # Instalar el paquete PKG que hay dentro (requiere sudo)
          sudo installer -pkg /Volumes/Chrome\ Remote\ Desktop\ Host/Chrome\ Remote\ Desktop\ Host.pkg -target /
          
          # Desmontar y limpiar
          hdiutil detach /Volumes/Chrome\ Remote\ Desktop\ Host
          rm "$CRD_DMG"

      - name: Bring up Tailscale
        run: |
          echo "üîí Bringing up Tailscale..."
          
          # Instalar Tailscale usando Homebrew (preinstalado en macos-latest)
          brew install tailscale
          
          # Iniciar el servicio de tailscaled en segundo plano (requiere sudo)
          sudo tailscaled install-system-daemon
          
          # Autenticar y conectar
          # El nombre del host se genera din√°micamente
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gh-crd-mac-$GITHUB_RUN_ID" --accept-routes
          
          # Obtener IP
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Register Chrome Remote Desktop Host
        run: |
          echo "üöÄ Registering Chrome Remote Desktop host..."
          
          # Variables (RECUERDA: El authCode caduca muy r√°pido, debes generarlo justo antes de correr el workflow)
          AUTH_CODE="4/0ASc3gC13cmzYwMBeCPJvr6SYXRu_21S36VSTr332O1W86SoZXRpnE6TihBHmb7v6Mf_RVQ"
          PIN="123456"
          HOSTNAME=$(hostname)
          
          # Ejecutar el binario de registro nativo de macOS
          # Este es el path est√°ndar donde Google instala el binario en macOS
          "/Applications/Chrome Remote Desktop Host.app/Contents/MacOS/remoting_start_host" \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="$HOSTNAME" \
            --pin="$PIN"

      - name: Keep CRD Online
        run: |
          echo ""
          echo "=== üçé Chrome Remote Desktop Active (macOS) ==="
          echo "Tailscale IP: $env:TAILSCALE_IP" 
          echo "Connect via Chrome Remote Desktop web using the PIN 123456"
          echo "============================================"
          
          # Loop infinito en Bash para mantener el runner vivo
          while true; do
            echo "[$(date)] CRD active... keeping session alive."
            sleep 300
          done
