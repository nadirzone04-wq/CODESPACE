name: macOS noVNC (Fix Instalación)

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar Tailscale y TigerVNC
        run: |
          # Instalamos solo lo que sabemos que está disponible
          brew install tailscale tiger-vnc
          
          # Iniciar Tailscale
          sudo tailscaled > /dev/null 2>&1 &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-mac-web

      - name: Descargar noVNC (Manual)
        run: |
          # Clonamos el repositorio de noVNC y websockify (el puente)
          git clone https://github.com/novnc/noVNC.git $HOME/noVNC
          git clone https://github.com/novnc/websockify.git $HOME/noVNC/utils/websockify

      - name: Configurar Servidor VNC
        run: |
          mkdir -p ~/.vnc
          echo "password123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Lanzar TigerVNC (el binario en Mac se llama vncserver)
          # Usamos la ruta completa de Homebrew para evitar fallos
          /opt/homebrew/opt/tiger-vnc/bin/vncserver :1 -geometry 1280x720 -depth 24
          sleep 5

      - name: Lanzar noVNC Proxy
        run: |
          # Ejecutamos el script launch.sh de noVNC
          # --vnc localhost:5901 es donde escucha TigerVNC
          # --listen 8080 es el puerto del navegador
          $HOME/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 8080 &
          sleep 5

      - name: ACCESO POR NAVEGADOR
        run: |
          IP=$(tailscale ip -4)
          echo "========================================================="
          echo "PASO 1: Conecta tu PC/Móvil a Tailscale"
          echo "PASO 2: Abre en tu navegador la siguiente URL:"
          echo ""
          echo "http://$IP:8080/vnc.html"
          echo ""
          echo "CONTRASEÑA VNC: password123"
          echo "========================================================="

      - name: Mantener vivo
        run: sleep 3600
