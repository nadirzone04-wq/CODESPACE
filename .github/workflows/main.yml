name: CRD-MacOS-Manual

on:
  workflow_dispatch:

jobs:
  crd-macos:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Set Wallpaper
        run: |
          echo "üñºÔ∏è Setting custom Wallpaper..."
          # Usamos -A "Mozilla..." para simular ser un navegador y evitar bloqueo 403/404
          curl -L -A "Mozilla/5.0" -o "$HOME/wallpaper.jpg" "https://drive.google.com/uc?export=download&id=1SmRFyijibBDEbnhYSilSGoxtD_-N2KXu"
          
          # Intentar aplicar fondo (con fallback por si falla en modo headless)
          osascript -e "tell application \"System Events\" to set picture of every desktop to \"$HOME/wallpaper.jpg\"" || true

      - name: Set up Chrome Remote Desktop
        run: |
          echo "‚¨áÔ∏è Downloading Chrome Remote Desktop..."
          dmg_path="$HOME/crd.dmg"
          
          # 1. Descarga MANUAL forzando User-Agent (Fix del error 404)
          # Usamos la URL oficial (sin 'edgedl') y fingimos ser Safari/Chrome
          curl -L -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
               -o "$dmg_path" \
               "https://dl.google.com/chrome-remote-desktop/chromeremotedesktophost.dmg"
          
          # 2. Montar el DMG
          echo "üíø Mounting DMG..."
          hdiutil attach "$dmg_path" -nobrowse
          
          # 3. Instalar el paquete .pkg que hay dentro (como un .msi en Windows)
          echo "üì¶ Installing PKG..."
          sudo installer -pkg /Volumes/Chrome\ Remote\ Desktop\ Host/Chrome\ Remote\ Desktop\ Host.pkg -target /
          
          # 4. Limpieza
          hdiutil detach /Volumes/Chrome\ Remote\ Desktop\ Host
          rm "$dmg_path"

      - name: Bring up Tailscale
        run: |
          echo "üîí Installing Tailscale..."
          # En macOS, la forma m√°s estable de instalar el servicio es brew (es nativo)
          # Descargar el .pkg manualmente suele fallar al registrar el servicio del sistema
          brew install tailscale
          
          # Levantar el daemon del sistema
          sudo tailscaled install-system-daemon
          
          echo "üîë Connecting to Tailscale..."
          # Autenticaci√≥n
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gh-mac-$GITHUB_RUN_ID" --accept-routes
          
          # Sacar IP
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Register Chrome Remote Desktop Host
        run: |
          echo "üöÄ Registering CRD Host..."
          
          # REEMPLAZA TU C√ìDIGO AQU√ç (Caduca r√°pido)
          # Generar en: https://remotedesktop.google.com/headless
          AUTH_CODE="4/0AVGzR1AR-AZjzXJpq4cq7daqk-H6U3gmJNl1TqBxgABRwJqd04KU-A1hZEQHN78PhtBV2w"
          PIN="123456"
          HOSTNAME=$(hostname)
          
          # Esta es la ruta donde el instalador (paso 2) ha dejado el programa
          APP_BIN="/Applications/Chrome Remote Desktop Host.app/Contents/MacOS/remoting_start_host"
          
          "$APP_BIN" \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="$HOSTNAME" \
            --pin="$PIN"

      - name: Keep CRD Online
        run: |
          echo "==================================="
          echo "‚úÖ macOS Ready"
          echo "IP Tailscale: $TAILSCALE_IP"
          echo "PIN: 123456"
          echo "==================================="
          
          # Loop infinito (versi√≥n Bash)
          while true; do
            echo "[$(date)] Keep alive..."
            sleep 300
          done
