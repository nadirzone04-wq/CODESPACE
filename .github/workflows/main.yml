name: MacOS-NoVNC-Tailscale

on:
  workflow_dispatch:

jobs:
  novnc-tailscale:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: 1. Activar VNC Nativo de macOS
        run: |
          echo "ðŸ–¥ï¸ Activando Apple Remote Desktop..."
          # Definimos contraseÃ±a estÃ¡ndar para VNC
          VNC_PASSWORD="password"
          
          # Comando de administraciÃ³n remota de Apple (kickstart)
          # Habilita el acceso VNC legado y configura permisos
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent -privs -all
          
          echo "âœ… VNC activo en puerto 5900"

      - name: 2. Instalar noVNC (Puente Web)
        run: |
          echo "ðŸŒ Preparando entorno Web..."
          # Clonamos el visor web
          git clone https://github.com/novnc/noVNC.git
          
          # Lanzamos el proxy en segundo plano (&)
          # Esto redirige el puerto web 6080 al puerto VNC 5900
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          echo "âœ… Web Server listo en puerto 6080"

      - name: 3. Conectar a Tailscale
        run: |
          echo "ðŸ”’ Conectando a la red privada..."
          brew install tailscale
          sudo tailscaled install-system-daemon
          
          # Generamos nombre Ãºnico
          TS_HOSTNAME="gh-mac-novnc-$GITHUB_RUN_ID"
          
          # Conectamos
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$TS_HOSTNAME"
          
          # Guardamos la IP para mostrarla luego
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_ENV

      - name: 4. DATOS DE CONEXIÃ“N
        run: |
          echo "======================================================="
          echo "ðŸŽ‰ SISTEMA LISTO"
          echo ""
          echo "1. AsegÃºrate de tener Tailscale conectado en tu PC."
          echo "2. Abre esta URL en tu navegador:"
          echo ""
          echo "   http://$TS_IP:6080/vnc.html?password=password&autoconnect=true"
          echo ""
          echo "======================================================="
          
          # Bucle infinito para mantener la sesiÃ³n
          while true; do sleep 300; done
