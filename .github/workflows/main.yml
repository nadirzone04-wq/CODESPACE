name: Debug macOS VNC (Tailscale Manual)

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar Tailscale en macOS
        run: |
          # Instalar Tailscale usando Homebrew
          brew install tailscale
          
          # Iniciar el demonio de Tailscale (necesario en macOS para que el CLI funcione)
          sudo tailscaled > /dev/null 2>&1 &
          sleep 5
          
          # Loguearse usando la Auth Key
          # Usamos --accept-routes para evitar conflictos de red
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-mac-runner

      - name: Configurar VNC (Screen Sharing)
        run: |
          VNC_PASSWORD="password123"
          
          # Comando oficial de Apple para activar el escritorio remoto
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvnpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          echo "VNC Activado correctamente."

      - name: OBTENER IP DE CONEXIÃ“N
        run: |
          echo "========================================================="
          echo "CONECTA TU PC LOCAL A TAILSCALE PRIMERO"
          echo "LUEGO, EN TU VISOR VNC, USA ESTA IP:"
          echo ""
          tailscale ip -4
          echo ""
          echo "Usuario: runner"
          echo "Password VNC: password123"
          echo "========================================================="

      - name: Mantener vivo (1 hora)
        run: sleep 3600
